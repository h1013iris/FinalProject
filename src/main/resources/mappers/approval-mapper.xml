<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="aprvMapper">
	
	<!-- 결재 완료 문서 -->
	<resultMap type="AprvDoc" id="aprvCompleteRSet">
		<result property="docNo" column="DOC_NO"/>
		<result property="docType" column="DOC_TYPE"/>
		<result property="docTitle" column="DOC_TITLE"/>
		<result property="drafter" column="DRAFTER"/>
		<result property="comDate" column="PRO_DATE"/>
	</resultMap>
	
	<!-- 결재 요청 문서 -->
	<resultMap type="AprvDoc" id="aprvRequestRSet">
		<result property="docNo" column="DOC_NO"/>
		<result property="docType" column="DOC_TYPE"/>
		<result property="docTitle" column="DOC_TITLE"/>
		<result property="drafter" column="EMP_NAME"/>
		<result property="draftDate" column="기안일"/>
		<result property="proDate" column="요청일"/>
	</resultMap>
	
	<!-- 결재 완료 문서 총 개수 -->
	<select id="selectListCount" resultType="_int">
		SELECT COUNT(*)
		FROM V_COMPLETE_DOC
	</select>
	
	<!-- 결재 완료 문서 리스트 -->
	<select id="selectList" resultMap="aprvCompleteRSet">
		SELECT *
		FROM V_COMPLETE_DOC
	</select>
	
	
	<!-- 문서 등록 -->
	
	<!-- 결재선 조회 -->
	<select id="selectDeptApprover" parameterType="string" resultType="Member">
		SELECT
			A.EMP_NO,
		    A.EMP_NAME,
		    B.JOB_NAME
		FROM USER_INFO A
		JOIN JOB_RANK_MANAGEMENT B ON A.JOB_NO = B.JOB_NO
		WHERE 1=1
		AND A.DEPARTMENT_NO = #{deptNo}
		AND A.JOB_NO IN (4, 7)
		ORDER BY B.JOB_NO
	</select>
	
	<!-- 부서 리스트 조회 -->
	<select id="selectDeptName" parameterType="string" resultType="string">
		SELECT DEPARTMENT_TITLE
		FROM DEPARTMENT_MANAGEMENT
		WHERE DEPARTMENT_NO = #{deptNo}
	</select>
	
	<!-- 결재 문서 등록 -->
	<insert id="insertAprvDoc" parameterType="AprvDoc">
		INSERT INTO APRV_DOCUMENT VALUES
		(SEQ_DOC_NO.CURRVAL, #{docType}, #{docTitle}, #{drafter}, #{firstAprv}, #{secondAprv}, DEFAULT, DEFAULT)
	</insert>
	
	<!-- 결재 기록 등록 -->
	<insert id="insertAprvHistory" parameterType="AprvHistory">
		INSERT INTO APRV_HISTORY VALUES
		(SEQ_APRV_HISTORY.NEXTVAL, SEQ_DOC_NO.CURRVAL, #{approver}, #{approverJob}, #{aprvPro}, DEFAULT)
	</insert>
	
	<!-- 휴가 신청서 등록 -->
	<insert id="insertLeaveApp" parameterType="LeaveForm">
		INSERT INTO LEAVE_APP VALUES
		(SEQ_LEAVE_APP.NEXTVAL, SEQ_DOC_NO.NEXTVAL, #{docTypeNo}, #{drafter}, #{drafterDept}, DEFAULT, #{vacType}, #{startDate}, #{endDate}, #{vacUseDays}, #{vacReason})
	</insert>
	
	<!-- 해당 날짜 근태 기록 조회 -->
	<select id="selectCmt" parameterType="AttendLog" resultType="AttendLog">
		SELECT
		    SUBSTR(TO_CHAR(ATTEND_TIME, 'YYYY/MM/DD HH24:MI:SS'), 12, 5) AS ATTEND_TIME2,
		    SUBSTR(TO_CHAR(LEAVE_TIME, 'YYYY/MM/DD HH24:MI:SS'), 12, 5) AS LEAVE_TIME2
		FROM ATTEND_LOG
		WHERE 1=1
		AND EMP_NO = #{empNo}
		AND ATTEND_DATE = TO_DATE(#{attendDate})
	</select>
	
	<!-- 근태 기록 수정 의뢰 신청서 등록 -->
	<insert id="insertCmtUpdateApp" parameterType="CmtUpdateForm">
		INSERT INTO CMT_UPDATE_APP VALUES
		(SEQ_CMT_UPD_APP.NEXTVAL, SEQ_DOC_NO.NEXTVAL, #{docTypeNo}, #{drafter}, #{drafterDept}, SYSDATE, 
		#{updateDate}, TO_DATE(#{beAttendTime}, 'YYYY-MM-DD HH24:MI'), TO_DATE(#{beLeaveTime}, 'YYYY-MM-DD HH24:MI'), 
		TO_DATE(#{attendTime}, 'YYYY-MM-DD HH24:MI'), TO_DATE(#{leaveTime}, 'YYYY-MM-DD HH24:MI'), #{updateReason})
	</insert>
	
	<!-- 부서 리스트 조회 -->
	<select id="selectDeptList" resultType="DepartmentList">
		SELECT * FROM DEPARTMENT_MANAGEMENT
	</select>
	
	<!-- 업무 기안서 등록 -->
	<insert id="insertBusDraft" parameterType="BusDraftForm">
		INSERT INTO BUSINESS_DFT VALUES
		(SEQ_BUSINESS_DFT.NEXTVAL, SEQ_DOC_NO.NEXTVAL, #{docTypeNo}, #{docTitle}, #{drafter}, #{drafterDept}, SYSDATE, #{enfDate}, #{coopDept}, #{dftContent})
	</insert>
	
	<!-- 업무 협조문 -->
	<insert id="insertBusCoop" parameterType="BusCoopForm">
		INSERT INTO BUSINESS_COOP VALUES
		(SEQ_BUSINESS_DFT.NEXTVAL, SEQ_DOC_NO.NEXTVAL, #{docTypeNo}, #{docTitle}, #{drafter}, #{drafterDept}, SYSDATE, #{receiveDept}, #{coopContent})
	</insert>
	
	<!-- 결재 요청 리스트 개수 -->
	<select id="requestListCount" parameterType="_int" resultType="_int">
		SELECT COUNT(*)
		FROM V_REQUEST_DOC
		WHERE DRAFTER = #{empNo}
	</select>
	
	<!-- 결재 요청 리스트 조회  -->
	<select id="selectRequestList" parameterType="_int" resultMap="aprvRequestRSet">
		SELECT *
		FROM V_REQUEST_DOC
		WHERE DRAFTER = #{empNo}
	</select>
	
	<!-- 해당 문서의 서식 번호 조회 -->
	<select id="selectDocTypeNo" parameterType="_int" resultType="_int">
		SELECT DOC_TYPE
		FROM APRV_DOCUMENT
		WHERE DOC_NO = #{docNo}
	</select>
	
	<!-- 해당 문서 결재자 조회 -->
	<select id="selectDocApprover" parameterType="_int" resultType="AprvDoc">
		SELECT
		    A.DOC_NO,
		    B.EMP_NAME AS FIRST_APRV,
		    D.JOB_NAME AS FIRST_JOB,
		    C.EMP_NAME AS SECOND_APRV,
		    E.JOB_NAME AS SECOND_JOB
		FROM APRV_DOCUMENT A
		JOIN USER_INFO B ON A.FIRST_APRV = B.EMP_NO
		JOIN USER_INFO C ON A.SECOND_APRV = C.EMP_NO
		JOIN JOB_RANK_MANAGEMENT D ON B.JOB_NO = D.JOB_NO
		JOIN JOB_RANK_MANAGEMENT E ON C.JOB_NO = E.JOB_NO
		WHERE A.DOC_NO = #{docNo}
	</select>
	
	<!-- 휴가 신청서 상세 조회 -->
	<select id="selectLeaveForm" parameterType="_int" resultType="LeaveForm">
		SELECT *
		FROM LEAVE_APP
		WHERE DOC_NO = #{docNo}
	</select>
	
	
</mapper>
